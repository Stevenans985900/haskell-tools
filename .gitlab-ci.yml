stages:
- build
- package

binaries:
  stage: build
  script:
  - nix build -L -o $BUILDER_ROOTS_CACHE_DIR/haskell-tools
  - cp -r $BUILDER_ROOTS_CACHE_DIR/haskell-tools/bin bin
  artifacts:
    name: "haskell-tools-$CI_BUILD_ID"
    paths:
    - bin
  tags:
  - coinmetrics
  - linux
  - nix

.docker-image:
  stage: package
  image: docker:latest
  services:
  - docker:dind
  dependencies:
  - binaries
  script:
  - cp Dockerfile bin/
  - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA -t $CI_REGISTRY_IMAGE:latest bin
  - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
  - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  - docker push $CI_REGISTRY_IMAGE:latest
  tags:
  - linux
  - docker
  only:
  - master
